
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.InetAddress;
import java.net.NetworkInterface;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.SocketException;
import java.util.Enumeration;

import javax.swing.JFrame;

import org.omg.PortableInterceptor.ServerIdHelper;

class Server
{
    static Server serverObj;
    static Socket client; // socket for client
    static String serverIpAddress;
    static int serverSessionId; // sessionID auto - generated by the server
    Server()
    {
        serverObj=this;
        Enumeration e = null;
        try {
            e = NetworkInterface.getNetworkInterfaces();
        } catch (SocketException e1) {
            // TODO Auto-generated catch block
            e1.printStackTrace();
        }
        /* extracting the server ip address */
        NetworkInterface n = (NetworkInterface) e.nextElement();
        Enumeration ee = n.getInetAddresses();
        InetAddress i = (InetAddress) ee.nextElement();
        i = (InetAddress) ee.nextElement();
        serverIpAddress=""+i;
        serverSessionId=(int)(Math.random()*10000);
       
        System.out.println(serverIpAddress);
        System.out.println(serverSessionId);
       
    }
    
    static ServerSocket serverSocket;
    public static void main(String args[])
    {
    	/********************************************************************/
		/* for testing...
		 * creating various student objects 
		 * these students have audio and text doubts
		 */
	/*	new Student("Lavish Kothari","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Kavleen Kalra","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Rakshit Kothari","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Nonujeet","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Rahul","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Deepak Sharma","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Piyush Kothari","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Mohit","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Ganesh","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Deepanshu","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Rajat","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Lalit Khatri","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Pooja Kothari","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Pankaj Modi","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Rahul Jain","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		new Student("Janit KK","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","audio");
		
		new Student("Lavish Kothari","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Exceptional handling null pointer exception","text");
		new Student("b","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("c","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("d","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("e","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("f","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("g","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("h","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("i","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("j","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("k","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("l","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("m","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("n","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("o","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
		new Student("p","123.123.123","/home/lavish/Server_ClassRoom_Interaction/Server_ClassRoom_Interaction/Images/a.jpg","Computer Graphics","text");
	*/	
		ServerFrame sf=new ServerFrame();
		sf.setVisible(true);
		sf.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
    	/********************************************************************/
    	
        new Server();
        sf.ipValueLabel.setText(serverIpAddress);
		sf.sessionIdValueLabel.setText(""+serverSessionId);
        try
        {
            serverSocket=new ServerSocket(5565);
            
        }
        catch(IOException io)
        {
            System.out.println("You got an exception : "+io);
        }
       
        try
        {
            while(true)
            {
                client=serverSocket.accept();
                System.out.println("a client accepted");
                new LoginThread(serverObj);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

class LoginThread implements Runnable
{
    File myFile = new File("s.txt");
    String username,roll,macid,doubtSubject,doubtText;
    
    String clientIpAddress,clientSessionID;
    Socket client;
    Server server;
    BufferedImage image;
    int count=0;
    LoginThread(Server server)
    {
    	//System.out.println("Thread started");
        this.server=server;
        client=server.client;
        Thread thread=new Thread(this);
        thread.start();
    }
    @Override
    public void run()
    {
        while(true)
        {
            try
            {
            
            	DataOutputStream dos=new DataOutputStream(client.getOutputStream());
				DataInputStream dis=new DataInputStream(client.getInputStream());
			    
            	System.out.println("Started");
            	String test;
            	test=dis.readUTF();
				if("USER".equals(test)){
				
				System.out.println("Distinguished");
				
				dos.writeUTF("1");
               	
                clientSessionID=dis.readUTF();
                
                if(clientSessionID==null)
                	break;
                System.out.println("Reached here -ci"+clientSessionID);
                if(server.serverSessionId==Integer.parseInt(clientSessionID))
                {
                    dos.writeUTF("1");
                    /*
                    FileOutputStream fos = new FileOutputStream("a.txt");
                    BufferedOutputStream out = new BufferedOutputStream(fos);
                    byte[] buffer = new byte[1024];
                    int count;
                    InputStream in = client.getInputStream();
                    while((count=in.read(buffer)) >0){
                        fos.write(buffer);
                    }
                    fos.close();
                   
                    image = ImageIO.read(client.getInputStream());
                     
                    InitStudent ist=new InitStudent(image);
                  	*/
                    client.close();
                count=1;
                    break;
                }
                else
                {
                    dos.writeUTF("0");
                }
				}
				
			else{
                System.out.println("Audio doubt entered");
				username=dis.readUTF();
				roll=dis.readUTF();
				macid=dis.readUTF();
				doubtSubject=dis.readUTF();
				doubtText=dis.readUTF();
				
				System.out.println("username="+username);
				System.out.println("roll="+roll);
				System.out.println("macid="+macid);
				System.out.println("doubtSubject="+doubtSubject);
				System.out.println("doubtText="+doubtText);
				
				
				new Student(username,roll,macid,doubtSubject,doubtText,"text");
				
				
				dos.writeUTF("received");
				
				
			     client.close();
	                count=1;
	                    break;
	               
				
				
				
				
				
				
			}	
            } 
            
            catch (Exception e) 
            {
                e.printStackTrace();
            }
            finally{
            	System.out.println("client ended");
            	try {
					client.close();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
            	for(int i=0;i<Student.studentListText.size();i++)
        			System.out.println(Student.studentListText.get(i).studentName);
  
            	if(count==1)
            		break;
        }}
    }
}